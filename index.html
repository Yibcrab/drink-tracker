<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>手搖是信仰 2026</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 先載入樣式，確保畫面不是白的 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #F0F7FF; 
            margin: 0; padding: 0; 
            overflow: hidden; 
            position: fixed; width: 100%; height: 100%; 
        }
        #fallback-ui {
            position: fixed; inset: 0; background: #F0F7FF;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #DBEAFE; border-top: 4px solid #3B82F6;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #debug-log {
            position: fixed; bottom: 10px; left: 10px; right: 10px;
            background: rgba(0,0,0,0.7); color: #00FF00; font-family: monospace;
            font-size: 10px; padding: 10px; border-radius: 10px; z-index: 1000;
            display: none; pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- 1. 即使 JS 壞掉也會顯示的基礎介面 -->
    <div id="fallback-ui">
        <div class="loader"></div>
        <p id="status-text" style="color:#60A5FA; font-weight:900;">信仰準備中...</p>
        <p id="fail-hint" style="display:none; color:#F87171; font-size:12px; margin-top:20px; text-align:center; padding:0 20px;">
            如果停留太久，請確認網路連線<br>或嘗試重新開啟 App
        </p>
    </div>

    <div id="debug-log"></div>
    <div id="root"></div>

    <!-- 載入核心庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // 即時偵錯腳本
        const log = (msg) => {
            console.log(msg);
            const el = document.getElementById('debug-log');
            // el.style.display = 'block'; // 若要看詳細日誌可開啟
            el.innerHTML += '> ' + msg + '<br>';
        };

        // 如果 5 秒後還沒載入 React，顯示提示
        setTimeout(() => {
            if (!window.React) {
                document.getElementById('status-text').innerHTML = "載入組件失敗";
                document.getElementById('fail-hint').style.display = 'block';
                log("核心組件載入超時，請檢查 CDN 連線");
            }
        }, 5000);
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            Plus, Calendar, BarChart3, Trash2, ChevronLeft, ChevronRight, 
            CupSoda, DollarSign, Heart, Store, Coffee, Star, Flower, Wind, Cloud, X 
        } = lucide;

        const App = () => {
            const [records, setRecords] = useState({});
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [form, setForm] = useState({ shop: '', item: '', ice: '微冰', sweetness: '微糖', price: '' });

            useEffect(() => {
                // 成功進入 React，移除 Loading
                const fallback = document.getElementById('fallback-ui');
                if (fallback) fallback.style.display = 'none';

                const localData = localStorage.getItem('drink_data_2026_final');
                if (localData) {
                    try { setRecords(JSON.parse(localData)); } catch(e) { console.error(e); }
                }
            }, []);

            const stats = useMemo(() => {
                const all = Object.values(records).flat();
                const shops = {};
                all.forEach(r => shops[r.shop] = (shops[r.shop] || 0) + 1);
                return {
                    count: all.length,
                    total: all.reduce((s, r) => s + r.price, 0),
                    top: Object.entries(shops).sort((a,b)=>b[1]-a[1])[0]?.[0] || '無'
                };
            }, [records]);

            const save = () => {
                if (!form.shop || !form.item || !form.price) return;
                const newR = { ...form, price: Number(form.price), date: selectedDate, id: Date.now().toString() };
                const updated = { ...records, [selectedDate]: [...(records[selectedDate] || []), newR] };
                setRecords(updated);
                localStorage.setItem('drink_data_2026_final', JSON.stringify(updated));
                setForm({ shop: '', item: '', ice: '微冰', sweetness: '微糖', price: '' });
                setIsModalOpen(false);
            };

            const del = (date, id) => {
                const updated = { ...records, [date]: records[date].filter(r => r.id !== id) };
                setRecords(updated);
                localStorage.setItem('drink_data_2026_final', JSON.stringify(updated));
            };

            return (
                <div className="min-h-screen bg-[#F0F7FF] relative pb-20 no-scrollbar overflow-x-hidden">
                    {/* 背景元素 */}
                    <div className="fixed inset-0 pointer-events-none opacity-20 z-0 overflow-hidden">
                        <Flower className="absolute top-10 left-10 animate-spin text-blue-300" style={{animationDuration:'15s'}} size={48}/>
                        <Flower className="absolute bottom-20 right-10 animate-pulse text-pink-300" size={64}/>
                    </div>

                    <header className="pt-12 pb-6 px-6 text-center relative z-10">
                        <div className="inline-block bg-white p-6 rounded-[2.5rem] shadow-xl border-4 border-white mb-4">
                            <CupSoda size={48} className="text-blue-400" />
                        </div>
                        <h1 className="text-3xl font-black text-blue-900 leading-tight">手搖是信仰 2026</h1>
                        <p className="text-blue-400 font-bold text-sm mt-2 flex items-center justify-center gap-2">
                             <Star size={14} className="fill-current text-yellow-300"/> 什麼時候能戒掉呢？ <Star size={14} className="fill-current text-yellow-300"/>
                        </p>

                        <div className="grid grid-cols-3 gap-2 mt-8 px-2">
                            <div className="bg-white/80 p-3 rounded-2xl border border-white">
                                <p className="text-[10px] text-slate-300 font-bold uppercase tracking-tighter">總杯數</p>
                                <p className="text-sm font-black text-slate-700">{stats.count}</p>
                            </div>
                            <div className="bg-white/80 p-3 rounded-2xl border border-white">
                                <p className="text-[10px] text-slate-300 font-bold uppercase tracking-tighter">總預算</p>
                                <p className="text-sm font-black text-slate-700">${stats.total}</p>
                            </div>
                            <div className="bg-white/80 p-3 rounded-2xl border border-white">
                                <p className="text-[10px] text-slate-300 font-bold uppercase tracking-tighter">最愛店</p>
                                <p className="text-[10px] font-black text-slate-700 truncate">{stats.top}</p>
                            </div>
                        </div>
                    </header>

                    <main className="px-5 relative z-10">
                        <div className="bg-white/95 rounded-[3rem] shadow-2xl border-[6px] border-white overflow-hidden p-1">
                            <div className="flex items-center justify-between px-6 py-4">
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="p-2 text-blue-400 active:scale-90"><ChevronLeft/></button>
                                <span className="font-black text-slate-800 text-lg">{currentDate.getFullYear()} / {currentDate.getMonth()+1}</span>
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="p-2 text-blue-400 active:scale-90"><ChevronRight/></button>
                            </div>
                            <div className="grid grid-cols-7 gap-1 px-3 pb-8 text-center">
                                {['日','一','二','三','四','五','六'].map(d => <div key={d} className="text-[10px] font-bold text-blue-200 mb-2">{d}</div>)}
                                {Array.from({ length: new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay() }).map((_, i) => <div key={i} />)}
                                {Array.from({ length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate() }).map((_, i) => {
                                    const d = i + 1;
                                    const ds = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                    const has = records[ds]?.length > 0;
                                    return (
                                        <div key={d} onClick={()=>{setSelectedDate(ds); setIsModalOpen(true);}} 
                                            className={`h-11 flex items-center justify-center rounded-xl font-black text-sm transition-all ${has ? 'bg-blue-500 text-white shadow-md' : 'bg-slate-50 text-slate-300 active:bg-blue-50'}`}>
                                            {d}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="mt-10 mb-10 text-center">
                            <p className="text-xs font-black text-blue-300 bg-white/40 inline-block px-5 py-2 rounded-full border border-white">今天的我也要喝得像個富翁一樣可愛 ✨</p>
                        </div>
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-end justify-center bg-blue-900/40 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-md h-[92vh] rounded-t-[3.5rem] p-8 flex flex-col shadow-2xl border-t-[10px] border-white animate-in slide-in-from-bottom duration-300">
                                <div className="w-12 h-1.5 bg-slate-100 rounded-full mx-auto mb-6 shrink-0" />
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-black text-slate-800 flex items-center gap-2"><Heart className="text-pink-400 fill-current" /> {selectedDate}</h3>
                                    <button onClick={()=>setIsModalOpen(false)} className="text-slate-300 p-2"><X size={32}/></button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 mb-6">
                                    {records[selectedDate]?.map(r => (
                                        <div key={r.id} className="bg-slate-50 p-5 rounded-[2rem] flex justify-between items-center border border-white shadow-sm">
                                            <div>
                                                <p className="font-black text-slate-700 text-lg">{r.shop} / {r.item}</p>
                                                <p className="text-xs text-blue-400 font-bold mt-1">{r.ice} | {r.sweetness} | <span className="text-pink-400 font-black">${r.price}</span></p>
                                            </div>
                                            <button onClick={() => del(selectedDate, r.id)} className="p-3 text-pink-300 active:bg-pink-500 active:text-white rounded-2xl"><Trash2 size={20}/></button>
                                        </div>
                                    ))}

                                    <div className="bg-white p-6 rounded-[2.8rem] border-4 border-blue-50 shadow-inner space-y-5">
                                        <h4 className="text-center font-black text-blue-900 uppercase tracking-widest text-sm">收藏這一杯美好 ✨</h4>
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="text" placeholder="店家" value={form.shop} onChange={e=>setForm({...form, shop:e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold text-sm outline-none" />
                                            <input type="text" placeholder="品項" value={form.item} onChange={e=>setForm({...form, item:e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold text-sm outline-none" />
                                        </div>
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="價格" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} className="flex-1 p-5 bg-slate-50 rounded-[2rem] border-none font-black text-3xl text-center outline-none" />
                                        </div>
                                        <button onClick={save} className="w-full py-5 bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-[2.5rem] font-black text-xl shadow-xl shadow-blue-100 active:scale-95 transition-all">收藏這一杯美好 ✨</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>