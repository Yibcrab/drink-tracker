<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>手搖是信仰 2026</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 核心腳本：改用更穩定的載入方式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #F0F7FF; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            position: fixed; 
            width: 100%; 
            height: 100%; 
        }
        #root { 
            height: 100%; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 20s linear infinite; }
        
        /* 防止點擊時出現藍色框框 */
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>
    <div id="root">
        <!-- 初始讀取畫面 -->
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#F0F7FF;">
            <div style="width:40px; height:40px; border:4px solid #BFDBFE; border-top:4px solid #3B82F6; border-radius:50%; animation: spin-slow 1s linear infinite; margin-bottom:15px;"></div>
            <p style="color:#60A5FA; font-weight:bold; font-size:1.1rem; letter-spacing:0.1em;">信仰載入中...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            Plus, Calendar, BarChart3, Trash2, ChevronLeft, ChevronRight, 
            CupSoda, DollarSign, Heart, Store, Coffee, Star, Flower, Wind, Cloud, X 
        } = lucide;

        // --- 安全的配置偵測 ---
        const getSafeConfig = () => {
            try {
                // 如果是自己架設沒有設定 Firebase，這裡會回傳空物件
                return JSON.parse(window.__firebase_config || '{}');
            } catch (e) { return {}; }
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [records, setRecords] = useState({});
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [form, setForm] = useState({ shop: '', item: '', ice: '微冰', sweetness: '微糖', price: '' });

            // 啟動與資料同步邏輯
            useEffect(() => {
                const config = getSafeConfig();
                
                // 優先檢查本地是否有資料（單機模式）
                const localData = localStorage.getItem('drink_data_2026');
                if (localData) {
                    try {
                        setRecords(JSON.parse(localData));
                    } catch(e) { console.error("Local data parse error"); }
                }

                if (!config.apiKey) {
                    console.log("進入單機離線模式");
                    return;
                }

                // 如果有 Firebase 配置，則啟動雲端同步
                const initCloud = async () => {
                    try {
                        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js');
                        const { getAuth, signInAnonymously, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js');
                        const { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');

                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const db = getFirestore(app);

                        signInAnonymously(auth);
                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                const appId = window.__app_id || 'drink-app-2026';
                                const q = collection(db, 'artifacts', appId, 'users', u.uid, 'records');
                                onSnapshot(q, (s) => {
                                    const d = {};
                                    s.forEach(doc => {
                                        const r = doc.data();
                                        if(!d[r.date]) d[r.date] = [];
                                        d[r.date].push({ id: doc.id, ...r });
                                    });
                                    setRecords(d);
                                    // 同步更新到本地快取
                                    localStorage.setItem('drink_data_2026', JSON.stringify(d));
                                });
                                window._db = { doc, setDoc, deleteDoc, db, collection };
                            }
                        });
                    } catch (e) { console.error("Cloud Error:", e); }
                };
                initCloud();
            }, []);

            // 存檔邏輯
            const handleSave = async () => {
                if (!form.shop || !form.item || !form.price) return;
                const newRecord = { ...form, price: Number(form.price), date: selectedDate, id: Date.now().toString() };
                
                // 雲端存檔
                if (window._db && user) {
                    const appId = window.__app_id || 'drink-app-2026';
                    await window._db.setDoc(window._db.doc(window._db.db, 'artifacts', appId, 'users', user.uid, 'records', newRecord.id), newRecord);
                } else {
                    // 單機存檔
                    const newRecords = { ...records, [selectedDate]: [...(records[selectedDate] || []), newRecord] };
                    setRecords(newRecords);
                    localStorage.setItem('drink_data_2026', JSON.stringify(newRecords));
                }
                setForm({ shop: '', item: '', ice: '微冰', sweetness: '微糖', price: '' });
                setIsModalOpen(false);
            };

            const handleDelete = async (id) => {
                if (window._db && user) {
                    const appId = window.__app_id || 'drink-app-2026';
                    await window._db.deleteDoc(window._db.doc(window._db.db, 'artifacts', appId, 'users', user.uid, 'records', id));
                } else {
                    const filtered = records[selectedDate].filter(r => r.id !== id);
                    const newRecords = { ...records, [selectedDate]: filtered };
                    setRecords(newRecords);
                    localStorage.setItem('drink_data_2026', JSON.stringify(newRecords));
                }
            };

            const stats = useMemo(() => {
                const all = Object.values(records).flat();
                const shops = {};
                all.forEach(r => shops[r.shop] = (shops[r.shop] || 0) + 1);
                return {
                    count: all.length,
                    total: all.reduce((sum, r) => sum + r.price, 0),
                    topShop: Object.entries(shops).sort((a,b)=>b[1]-a[1])[0]?.[0] || '無'
                };
            }, [records]);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#F0F7FF] relative pb-10 no-scrollbar overflow-x-hidden">
                    {/* 背景裝飾 */}
                    <div className="fixed inset-0 pointer-events-none opacity-20 z-0">
                        <Flower className="absolute top-10 left-10 animate-spin-slow text-blue-300" size={60}/>
                        <Flower className="absolute bottom-20 right-10 animate-spin-slow text-pink-300" size={80}/>
                    </div>

                    <header className="pt-12 pb-6 px-6 text-center relative z-10">
                        <div className="inline-block bg-white p-6 rounded-[2.5rem] shadow-xl border-4 border-white mb-4">
                            <CupSoda size={48} className="text-blue-400" />
                        </div>
                        <h1 className="text-3xl font-black text-blue-900 leading-tight">手搖是信仰 2026</h1>
                        <p className="text-blue-400 font-bold text-sm mt-2 flex items-center justify-center gap-2">
                             <Star size={14} className="fill-current text-yellow-300"/> 什麼時候能戒掉呢？ <Star size={14} className="fill-current text-yellow-300"/>
                        </p>

                        <div className="grid grid-cols-3 gap-2 mt-8">
                            <div className="bg-white/80 p-3 rounded-2xl shadow-sm border border-white">
                                <p className="text-[10px] text-slate-300 font-black">總杯數</p>
                                <p className="text-sm font-black text-slate-700">{stats.count}</p>
                            </div>
                            <div className="bg-white/80 p-3 rounded-2xl shadow-sm border border-white">
                                <p className="text-[10px] text-slate-300 font-black">總開銷</p>
                                <p className="text-sm font-black text-slate-700">${stats.total}</p>
                            </div>
                            <div className="bg-white/80 p-3 rounded-2xl shadow-sm border border-white">
                                <p className="text-[10px] text-slate-300 font-black">最愛店家</p>
                                <p className="text-sm font-black text-slate-700 truncate">{stats.topShop}</p>
                            </div>
                        </div>
                    </header>

                    <main className="px-5 relative z-10">
                        <div className="bg-white/90 rounded-[3rem] shadow-2xl border-[6px] border-white overflow-hidden p-2">
                            <div className="flex items-center justify-between px-6 py-4">
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="p-2 text-blue-400 active:scale-90 transition-all"><ChevronLeft/></button>
                                <span className="font-black text-slate-800 text-lg">{currentDate.getFullYear()} / {currentDate.getMonth()+1}</span>
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="p-2 text-blue-400 active:scale-90 transition-all"><ChevronRight/></button>
                            </div>
                            <div className="grid grid-cols-7 gap-1 px-4 pb-8 text-center">
                                {['日','一','二','三','四','五','六'].map(d => <div key={d} className="text-[10px] font-bold text-blue-200 mb-2">{d}</div>)}
                                {Array.from({ length: new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay() }).map((_, i) => <div key={i} />)}
                                {Array.from({ length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate() }).map((_, i) => {
                                    const d = i + 1;
                                    const ds = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                    const has = records[ds]?.length > 0;
                                    return (
                                        <div key={d} onClick={()=>{setSelectedDate(ds); setIsModalOpen(true);}} 
                                            className={`h-11 flex items-center justify-center rounded-xl font-black transition-all cursor-pointer ${has ? 'bg-blue-500 text-white shadow-md' : 'bg-slate-50 text-slate-300 active:bg-blue-50'}`}>
                                            {d}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="mt-10 mb-10 flex items-center justify-center gap-4 text-blue-300 font-black">
                            <Flower className="animate-spin-slow" size={20}/>
                            <p className="text-xs bg-white/60 px-4 py-2 rounded-full border border-white">今天的我也要喝得像個富翁一樣可愛 ✨</p>
                            <Flower className="animate-spin-slow" size={20}/>
                        </div>
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-end justify-center bg-blue-900/40 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-md h-[92vh] rounded-t-[3.5rem] p-8 flex flex-col shadow-2xl overflow-y-auto no-scrollbar border-t-[10px] border-white animate-in slide-in-from-bottom duration-300">
                                <div className="w-12 h-1.5 bg-slate-100 rounded-full mx-auto mb-6 shrink-0" />
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-black text-slate-800 flex items-center gap-2"><Heart className="text-pink-400 fill-current" size={24} /> {selectedDate}</h3>
                                    <button onClick={()=>setIsModalOpen(false)} className="text-slate-300 p-2 active:scale-90"><X size={32}/></button>
                                </div>
                                
                                <div className="space-y-4 mb-8">
                                    {records[selectedDate]?.map(r => (
                                        <div key={r.id} className="bg-slate-50 p-5 rounded-[2rem] flex justify-between items-center border border-white shadow-sm">
                                            <div>
                                                <p className="font-black text-slate-700 text-lg">{r.shop} / {r.item}</p>
                                                <p className="text-xs text-blue-400 font-bold mt-1">{r.ice} | {r.sweetness} | <span className="text-pink-400 font-black">${r.price}</span></p>
                                            </div>
                                            <button onClick={() => handleDelete(r.id)} className="p-3 bg-white text-pink-300 rounded-2xl active:bg-pink-500 active:text-white transition-all"><Trash2 size={20}/></button>
                                        </div>
                                    ))}
                                </div>

                                <div className="space-y-4 bg-white p-6 rounded-[2.8rem] border-4 border-blue-50 shadow-inner">
                                    <h4 className="text-center font-black text-blue-900 mb-2 uppercase tracking-widest">收藏這一杯美好 ✨</h4>
                                    <div className="grid grid-cols-2 gap-3">
                                        <input type="text" placeholder="店家" value={form.shop} onChange={e=>setForm({...form, shop:e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold outline-none placeholder:text-slate-300" />
                                        <input type="text" placeholder="品項" value={form.item} onChange={e=>setForm({...form, item:e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold outline-none placeholder:text-slate-300" />
                                    </div>
                                    <div className="flex gap-2">
                                        <input type="number" placeholder="價格" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} className="flex-1 p-5 bg-slate-50 rounded-[2rem] border-none font-black text-3xl text-center outline-none placeholder:text-slate-200" />
                                    </div>
                                    <button onClick={handleSave} className="w-full py-5 bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-[2.5rem] font-black text-xl shadow-xl shadow-blue-100 active:scale-95 transition-all">收藏這一杯美好 ✨</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>